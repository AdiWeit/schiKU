<meta charset="utf-8">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.js"></script>
<select id="textSelctor" onchange="neededTest = words['kreisUnna'][value - 1]; console.log(window.getSelection())">
  <option value="1">Test 1</option>
  <option value="2">Test 2</option>
  <option value="3">Test 3</option>
  <option value="4">Test 4</option>
  <option value="5">Test 5</option>
  <option value="6">Test 6</option>
</select>
<br>
<button type="button" id="addPupil" onclick="addPupil();" name="button">Schüler hinzufügen</button>
<script>
  var words = {kreisUnna: [{kathegorien: ["ku", "2 Silben", "3 Silben"], words: ["La-ma", "Na-se", "Hu-pe", "Ro-se", "Fa-den", "Ho-se", "Ha-fen", "Sa-la-mi", "Fi-na-le", "Do-mi-no", "Ka-no-ne", "Pe-da-len", "Ta-pe-te", "Ku-si-ne", "Ra-ke-te"]}, {kathegorien: ["au", "ei", "sch", "2 Silben", "3 Silben"], words: ["Hau-fen", "An-teil", "O-fen", "Ein-kauf", "Du-sche", "Pi-rat", "Rei-fen", "Aus-lauf", "Schein", "Ka-min", "Rau-pe", "Um-tausch", "Ei-sen", "Ma-schi-ne", "En-de"]}, {kathegorien: ["au", "ei", "ö", "w", "er", "el", "2 Silben", "3 Silben", "4 Silben"], words: ["Wein", "Rei-ter", "Am-pel", "Na-del", "Ei-mer", "Aus-weis", "Dö-ner", "Schön-heit", "Al-ter", "Le-der-ho-se", "Me-lo-nen-scha-le", "Nu-del-sa-lat", "Mo-den-schau", "Ki-lo-me-ter", "Mö-wen-fe-der"]}, {kathegorien: ["au", "ei", "ö", "ü", "g", "b", "er", "2 Silben", "3 Silben", "4 Silben"], words: ["Gei-ge", "Bau-er", "Eu-le", "Se-gel", "Bi-ber", "Beu-tel", "Ga-bel", "Ge-mü-se", "Scheu-nen-tor", "Ge-heim-tür", "Mö-bel-wa-gen", "Bü-gel-ei-sen", "Le-be-we-sen", "Ge-mein-heit", "O-fen-feu-er"]}, {kathegorien: [], words: ["Ba-de-wan-ne", "Re-gen-man-tel", "Per-len-ket-te", "Ha-sen-fel-le", "Wasch-be-cken", "Ra-ben-fe-der", "Me-lo-nen-ker-ne", "Waf-fel-ei-sen", "Las-so-wer-fer", "Mö-bel-pa-cker",
"Scher-ben-hau-fen", "Le-be-we-sen", "Kel-ler-e-cke", "Ta-fel-lap-pen", "Lam-pen-schal-ter"]}, {kathegorien: [], words: ["Hin-weis-schil-der", "Lie-fer-wa-gen", "Win-ter-wet-ter", "Schie-be-tür", "Ge-wit-ter-him-mel",
"Wi-ckel-tisch", "Ge-heim-nis-se", "Tin-ten-kil-ler", "Lie-ge-wie-se", "Un-ter-kie-fer", "Rin-der-her-de", "Lie-bes-lie-der", "Re-gen-rin-ne", "Kin-der-wip-pe"]}, {kathegorien: [], words: ["Son-der-an-ge-bo-te", "Hun-de-fut-ter", "Sol-da-ten-ru-fe", "Kar-tof-fel-sor-te", "Bu-ckel-wa-le", "But-ter-do-se", "Eis-schol-le", "Re-gen-ton-ne", "Schul-ter-wun-de", "Nu-del-sup-pe", "Win-ter-soc-ken", "Fisch-kut-ter"]}, {kathegorien: [], words: ["Sa-lat-schüs-sel", "Ra-ke-ten-böl-ler", "Kör-per-teil", "Re-gen-wür-mer", "Hun-de-hüt-te", "Ka-mel-hö-cker", "Dö-ner-bu-de", "Sup-pen-löf-fel", "Da-men-hü-te", "Fül-ler-tin-te", "Schü-ler-wün-sche", "Wör-ter-lis-te", "Rü-cken-num-mer", "Lö-wen-köp-fe"]}]};
var neededTest = words['kreisUnna'][0];
var pupils = 0;
var selectedElementId = {parent: 'pupilSheet1', element: 'pupilsWriting 1'};
/*
* PURPOSE : fügt die Elemente für einen neuen Schüler hinzu
*/
document.getElementById('addPupil').style.left = 300 + "px";
document.getElementById('addPupil').style.position = 'fixed'
function addPupil() {
  pupils++;
  addElement({id: 'pupilSheet' + pupils, style: 'width:21cm; height:29.7cm'}, 'div');
  addElement({placeholder: 'Name Schüler', id: 'name', oninput: 'selectedElementId.element = id; selectedElementId.parent = "pupilSheet' + pupils + '"; dataChanged(id, value);'}, 'input', 'pupilSheet' + pupils);
  addElement({placeholder: 'Klasse', id: 'class' + pupils, oninput: 'selectedElementId.element = id; selectedElementId.parent = "pupilSheet' + pupils + '"; dataChanged(id, value);'}, 'input', 'pupilSheet' + pupils);
  addElement({placeholder: 'Datum', id: 'date' + pupils, oninput: 'selectedElementId.element = id; selectedElementId.parent = "pupilSheet' + pupils + '"; dataChanged(id, value);'}, 'input', 'pupilSheet' + pupils);
  addElement({}, 'br', 'pupilSheet' + pupils);
  for (var i = 0; i < neededTest.words.length; i++) {
    addElement({innerText: replaceAll(neededTest.words[i], '-', ''), id: 'word ' + (i + 1)}, 'a', 'pupilSheet' + pupils);
    addElement({id: 'pupilsWriting ' + (i + 1), class: 'writingPupilSheet' + pupils, placeholder: 'Schreibung Schüler', oninput: 'markErrors(id, "pupilSheet' + pupils + '");', onchange: 'pupilsWritingFinished(id);', title: 'Die Eingabe wird automatisch "korregiert". \nFalls die automatische Korrektur Fehler enthalten sollte, können sie die Anzahl der Graphemtreffer korregieren.\nWenn der Schüler das Wort komplett richtig geschrieben hat, geben sie nur "r" für richtig ein!'}, 'input', 'pupilSheet' + pupils);
    addElement({id: 'correction ' + (i + 1)}, 'div', 'pupilSheet' + pupils);

    addElement({}, 'br', 'pupilSheet' + pupils);

  }
  addElement({id: 'allGraphemes' + pupils, style: 'font-size: 30'}, 'a', 'pupilSheet' + pupils);
  addElement({}, 'br', 'pupilSheet' + pupils);
  addElement({id: 'divGraph' + pupils}, 'div', 'pupilSheet' + pupils);
  addElement({id: 'texturpupilSheet' + pupils}, 'canvas', 'divGraph' + pupils);
  addElement({}, 'br', 'pupilSheet' + pupils);
}
function findChild(childType, idOfElement, idOfChild, elementNotId){
  if (!elementNotId) var element = document.getElementById(idOfElement);
  else var element = idOfElement;
  return element.querySelector('[' + childType + '="' + idOfChild + '"]');
}
function pupilsWritingFinished(id, restoringData) {
  if (findChild('id', selectedElementId.parent, id).value == "r") {
    findChild('id', selectedElementId.parent, id).value = findChild('id', selectedElementId.parent, "word " + id.replace("pupilsWriting ", "")).innerText;
    markErrors(id, selectedElementId.parent, true);
  }
  if (!restoringData) getEveryCategory();
}
// TODO: Bei anderem Test pupilSheet wieder auf 1
var auswertung = {allGraphemtreffer: {possible: 0, got: 0}, wrongLetters: {}, letter: {}};
var inputs = {};
if (localStorage.getItem('inputsSchiku') && localStorage.getItem('inputsSchiku') != 'undefined' && confirm('Wollen sie zuletzt ausgefüllten Tests wiederherstellen? Wenn sie auf abbrechen oder cancel klicken wird der Fortschritt verloren gehen.')) inputs = JSON.parse(localStorage.getItem('inputsSchiku'));
else localStorage.setItem('inputsSchiku', 'undefined');
for (var i3 = 0; i3 < Object.keys(inputs).length; i3++) {
  var testAktuell = Object.keys(inputs)[i3];
  neededTest = words['kreisUnna'][testAktuell.replace('Test ', '') - 1];
  textSelctor.value = testAktuell.replace('Test ', '');
for (var i = 0; i < Object.keys(inputs[testAktuell]).length; i++) {
  addPupil();
  var sheetAktuell = Object.keys(inputs[testAktuell])[i];
  var minusI = 0;
  for (var i1 = 0; i1 < Object.keys(inputs[testAktuell][ Object.keys(inputs[testAktuell])[i]]).length; i1++) {
    var idAktuell = Object.keys(inputs[testAktuell][ Object.keys(inputs[testAktuell])[i]])[i1];
    if (idAktuell.includes('pupilsWriting')) {
    findChild('id', sheetAktuell, idAktuell).value = inputs[testAktuell][sheetAktuell][idAktuell];
    markErrors(idAktuell, sheetAktuell);
    pupilsWritingFinished(idAktuell, true);
  }
  else {
    findChild('id', sheetAktuell, idAktuell).value = inputs[testAktuell][sheetAktuell][ idAktuell];
    minusI++;
  }
  }
  pupilsWritingFinished(idAktuell);
}
}
neededTest = words['kreisUnna'][0];
selectedElementId = {parent: 'pupilSheet1', element: 'pupilsWriting 1'};
function dataChanged(id, value) {
  if (!inputs['Test ' + textSelctor.value]) inputs['Test ' + textSelctor.value] = {};
  if (!inputs['Test ' + textSelctor.value][selectedElementId.parent]) inputs['Test ' + textSelctor.value][selectedElementId.parent] = {};
  inputs['Test ' + textSelctor.value][selectedElementId.parent][id] = value;
  localStorage.setItem('inputsSchiku', JSON.stringify(inputs));
}
function markErrors(id, parentId, doNotMark) {
  if (!inputs['Test ' + textSelctor.value]) inputs['Test ' + textSelctor.value] = {};
  if (!inputs['Test ' + textSelctor.value][parentId]) inputs['Test ' + textSelctor.value][parentId] = {};
  inputs['Test ' + textSelctor.value][parentId][id] = findChild('id', selectedElementId.parent, id).value;
  localStorage.setItem('inputsSchiku', JSON.stringify(inputs));
  selectedElementId = {parent: parentId, element: id};
  var correct = findChild('id', selectedElementId.parent, 'word ' + id.replace('pupilsWriting ', '')).innerText;
  var wrong = findChild('id', selectedElementId.parent, 'pupilsWriting ' + id.replace('pupilsWriting ', '')).value;
  var wrongI = 0;
  var newWord = [];
  var addI = 0;
  var doubleError = 0;
  var graphemFehler = 0;
  var wordCorrectionChild = findChild('id', selectedElementId.parent, 'correction ' + id.replace('pupilsWriting ', ''));
  for (var i = 0; findChild('id', wordCorrectionChild, 'correctionLetter', true); i++) {
    findChild('id', wordCorrectionChild, 'correctionLetter', true).remove();
  }
  try {
    findChild('id', wordCorrectionChild, 'graphemtrefferGot', true).remove();
    findChild('id', wordCorrectionChild, 'graphemtrefferPossible', true).remove();
    findChild('id', wordCorrectionChild, 'graphemtrefferSlash', true).remove();
  } catch (e) {console.log(e);}
  for (var i = 0; i < wrong.length; i++) {
    newWord.push({letter: wrong[i], colour: "white"});
  }
  for (var i = 0; i < correct.length && wrong[i]; i++) {
    // check letter difference: following letter wrong
    if (correct[i] != wrong[wrongI] && (!wrong[wrongI + 1] || (wrong[wrongI + 1] && wrong[wrongI + 1] != correct[i]))) {
      if ((/*wrong[wrongI] == wrong[wrongI].toLowerCase() || */correct[i].toLowerCase() != wrong[wrongI].toLowerCase()/*capitalizeFirstLetter(correct[i]) == correct[i]*/)/* && !(capitalizeFirstLetter(correct[i]) == correct[i] && correct[i].toLowerCase() == wrong[wrongI].toLowerCase())*/) {
        graphemFehler++;
        if (!auswertung.wrongLetters[selectedElementId.parent]) auswertung.wrongLetters[selectedElementId.parent] = {};
        if (!auswertung.wrongLetters[selectedElementId.parent][correct]) auswertung.wrongLetters[selectedElementId.parent][correct] = {};
        if (!auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()]) auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()] = 0;
        auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()]++;
      }
      console.log(correct[i] + " before " + wrong[wrongI]);
      // check if letter missing
      if ((!wrong[wrongI + 1] && (!wrong[wrongI] || wrong[wrongI].toLowerCase() != correct[i + 1])) || (wrong[wrongI + 1] && wrong[wrongI + 1].toLowerCase() == correct[i + 1])) {
        console.log("remove " + wrong[wrongI] + " pos. " + wrongI);
        if (newWord[wrongI + addI]) newWord[wrongI + addI].colour = "#FD6441/*red*/";
        wrongI++;

        // check if doubleError
        if (wrong[wrongI - 2] == wrong[wrongI - 1]) {
          newWord.splice(wrongI + addI, 0, {letter: '_', colour: "white"});
          addI++;
          doubleError++;
        }
}
else {
  newWord.splice(wrongI + addI, 0, {letter: '_', colour: "white"});
  addI++;
  // graphemFehler++;
}
    }
    // too much before end
    else if (((wrong[wrongI + 1] && wrong[wrongI + 1] == correct[i])) && correct[i] != wrong[wrongI]) {
      console.log("remove " + wrong[wrongI] + " pos. " + wrongI);
      newWord[wrongI + addI].colour = "#FD6441/*red*/";
      doubleError++;
      i--;
      graphemFehler++;
      // if (!auswertung.wrongLetters[selectedElementId.parent]) auswertung.wrongLetters[selectedElementId.parent] = {};
      // if (!auswertung.wrongLetters[selectedElementId.parent][correct]) auswertung.wrongLetters[selectedElementId.parent][correct] = {};
      // if (!auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()]) auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()] = 0;
      // auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()]++;
    }
    if (!(correct[i] != wrong[wrongI] && (!wrong[wrongI + 1] || wrongI > i || (wrong[wrongI + 1] && wrong[wrongI + 1] != correct[i]))) || (wrong[wrongI + 1] && wrong[wrongI + 1].toLowerCase() == correct[i + 1])) wrongI++;
  }
  // check end missing
  for (var i = i; newWord.length - doubleError < correct.length; i++) {
    newWord.push({letter: '_', colour: "white"});
    graphemFehler++;
    if (!auswertung.wrongLetters[selectedElementId.parent]) auswertung.wrongLetters[selectedElementId.parent] = {};
    if (!auswertung.wrongLetters[selectedElementId.parent][correct]) auswertung.wrongLetters[selectedElementId.parent][correct] = {};
    if (!auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()]) auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()] = 0;
    auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()]++;
  }
  // check too much in the end
  for (var i = wrongI + addI; i < newWord.length && i >= correct.length; i++) {
    console.log("remove " + wrong[i]);
    if (newWord[i].letter != '_') {
      newWord[i].colour = "#FD6441/*red*/";
      graphemFehler++;
      // if (!auswertung.wrongLetters[selectedElementId.parent]) auswertung.wrongLetters[selectedElementId.parent] = {};
      // if (!auswertung.wrongLetters[selectedElementId.parent][correct]) auswertung.wrongLetters[selectedElementId.parent][correct] = {};
      // if (!auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()]) auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()] = 0;
      // auswertung.wrongLetters[selectedElementId.parent][correct][newWord[i].toLowerCase()]++;
    }
  }
  console.log(newWord);
  for (var i = 0; i < newWord.length && !doNotMark && graphemFehler > 0; i++) {
    addElement({id: 'correctionLetter', class: 'correctionLetter' + i, innerText: newWord[i].letter, style: 'background-color:' + newWord[i].colour + ';', title: 'klicken, um ' + newWord[i].letter + ' als gespiegelt (blau) zu markieren.', onclick: 'changeMirror(' + i + ', "' + id + '");'}, 'strong', /*'correction ' + id.replace('pupilsWriting ', '')*/wordCorrectionChild, true);
  }
  if (correct.length - graphemFehler < 0) graphemFehler = correct.length;
  if (!doNotMark && graphemFehler > 0) {
    addElement({value: correct.length - graphemFehler, id: 'graphemtrefferGot', oninput: 'getAllGraphemtreffer();', class: 'graphemtrefferGot' + capitalizeFirstLetter(selectedElementId.parent), style: 'width: 25;'}, 'input', wordCorrectionChild, true);
    addElement({innerText: '/', id: 'graphemtrefferSlash', style: 'width: 25;'}, 'a', wordCorrectionChild, true);
    addElement({value: correct.length, id: 'graphemtrefferPossible', oninput: 'getAllGraphemtreffer();', class: 'graphemtrefferPossible' + capitalizeFirstLetter(selectedElementId.parent), style: 'width: 25;'}, 'input', wordCorrectionChild, true);
    findChild('id', selectedElementId.parent, id).style.backgroundColor = "red";
  }
  else {
    addElement({style: 'display: none;', value: correct.length - graphemFehler, id: 'graphemtrefferGot', class: 'graphemtrefferGot' + capitalizeFirstLetter(selectedElementId.parent)}, 'input', wordCorrectionChild, true);
    addElement({style: 'display: none;', value: correct.length, id: 'graphemtrefferPossible', class: 'graphemtrefferPossible' + capitalizeFirstLetter(selectedElementId.parent)}, 'input', wordCorrectionChild, true);
    findChild('id', selectedElementId.parent, id).style.backgroundColor = "green";
  }
  if ((doNotMark || correct == wrong) && !auswertung.wrongLetters[selectedElementId.parent]) auswertung.wrongLetters[selectedElementId.parent] = {};
  if (doNotMark || correct == wrong) auswertung.wrongLetters[selectedElementId.parent][correct] = {};
  getAllGraphemtreffer(doNotMark, graphemFehler, correct);
}
function getAllGraphemtreffer(/*doNotMark, graphemFehler, correct*/) {
  auswertung.allGraphemtreffer.possible = 0;
  auswertung.allGraphemtreffer.got = 0;
  for (var i = 0; i < document.getElementsByClassName("graphemtrefferGot" + capitalizeFirstLetter(selectedElementId.parent)).length; i++) {
    auswertung.allGraphemtreffer.possible += JSON.parse(document.getElementsByClassName("graphemtrefferPossible" + capitalizeFirstLetter(selectedElementId.parent))[i].value);
    auswertung.allGraphemtreffer.got += JSON.parse(document.getElementsByClassName("graphemtrefferGot" + capitalizeFirstLetter(selectedElementId.parent))[i].value);
  }
  document.getElementById('allGraphemes' + selectedElementId.parent.toString().split('Sheet')[1]).innerText = 'gesamt ' + auswertung.allGraphemtreffer.got + '/' + auswertung.allGraphemtreffer.possible;
}
function getEveryCategory() {
    for (var i = 0; i < neededTest.kathegorien.length; i++) {
      auswertung[neededTest.kathegorien[i]] = {got: 0, possible: 0};
        for (var i1 = 0; i1 < document.getElementsByClassName('writing' + capitalizeFirstLetter(selectedElementId.parent)).length; i1++) {
          if (neededTest.kathegorien[i].includes('Silben')) {
          if (neededTest.words[i1].toString().split('-').length == neededTest.kathegorien[i].replace(' Silben', '') && replaceAll(neededTest.words[i1], '-', '').toLowerCase() == document.getElementsByClassName('writing' + capitalizeFirstLetter(selectedElementId.parent))[i1].value.toLowerCase()) {
            auswertung[neededTest.kathegorien[i]].got++;
          }
          if (neededTest.words[i1].toString().split('-').length == neededTest.kathegorien[i].replace(' Silben', '')) auswertung[neededTest.kathegorien[i]].possible++;
        }
      }
    }
    auswertung.letter[selectedElementId.parent] = {};
    for (var i = 0; i < neededTest.words.length; i++) {
      try {
      var wordNow = replaceAll(neededTest.words[i], '-', '');
        var wrongLetterAblage = JSON.parse(JSON.stringify(auswertung.wrongLetters[selectedElementId.parent][wordNow]));
        console.log(wordNow);
        for (var i1 = 0; i1 < wordNow.length; i1++) {
          if (!auswertung.letter[selectedElementId.parent][wordNow[i1].toLowerCase()]) auswertung.letter[selectedElementId.parent][wordNow[i1].toLowerCase()] = {possible: 0, got: 0};
          auswertung.letter[selectedElementId.parent][wordNow[i1].toLowerCase()].possible++;
          if (!auswertung.wrongLetters[selectedElementId.parent][wordNow] || !auswertung.wrongLetters[selectedElementId.parent][wordNow][wordNow[i1].toLowerCase()]) {
            auswertung.letter[selectedElementId.parent][wordNow[i1].toLowerCase()].got++;
        }
        if (auswertung.wrongLetters[selectedElementId.parent][wordNow] && auswertung.wrongLetters[selectedElementId.parent][wordNow][wordNow[i1].toLowerCase()]) auswertung.wrongLetters[selectedElementId.parent][wordNow][wordNow[i1].toLowerCase()]--;
      }
      auswertung.wrongLetters[selectedElementId.parent][wordNow] = wrongLetterAblage;
     } catch (e) {
       console.log('not filled already');
     }
    }
    console.log(auswertung);
    var wrongList = [];
    var rightList = [];
    auswertung.letter[selectedElementId.parent] = sortObjectByKey(auswertung.letter[selectedElementId.parent]);
    var cathegoryList = Object.keys(auswertung.letter[selectedElementId.parent]);
    for (var i = 0; i < Object.keys(auswertung.letter[selectedElementId.parent]).length; i++) {
      wrongList.push(auswertung.letter[selectedElementId.parent][Object.keys(auswertung.letter[selectedElementId.parent])[i]].possible - auswertung.letter[selectedElementId.parent][Object.keys(auswertung.letter[selectedElementId.parent])[i]].got);
      rightList.push(auswertung.letter[selectedElementId.parent][Object.keys(auswertung.letter[selectedElementId.parent])[i]].got);
    }
    for (var i = 0; i < Object.keys(auswertung).length; i++) {
      if (Object.keys(auswertung)[i].includes('Silben')) {
        cathegoryList.push(Object.keys(auswertung)[i]);
        wrongList.push(auswertung[Object.keys(auswertung)[i]].possible - auswertung[Object.keys(auswertung)[i]].got);
        rightList.push(auswertung[Object.keys(auswertung)[i]].got);
      }
    }
    addChart(cathegoryList, {wrong: wrongList, right: rightList});
}
function changeMirror(index, wordNumber) {
  findChild('class',  findChild('id', selectedElementId.parent, wordNumber.replace('pupilsWriting', 'correction')), 'correctionLetter' + index, true).style.backgroundColor = '#00BFFF'/*blue*/;
}
function capitalizeFirstLetter(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
}
function sortObjectByKey(obj) {
  var keys = [],
  k, i, len;
for (k in obj) {
  if (obj.hasOwnProperty(k)) {
    keys.push(k);
  }
}
keys.sort();
len = keys.length;
var sorted = {}
for (i = 0; i < len; i++) {
  k = keys[i];
  sorted[k] = obj[k]
}
return sorted;
}
/*
 * PURPOSE : generiert ein neues HTML Element
 *  PARAMS : attr - Attribute des Elements
 *           elm - Typ des Elements
 *           childOf - in welchem welches HTML Element soll das neue eingefügt werden? (wenn nicht angegeben wird es ganz außen unten eingefügt)
 */
  function addElement(attr, elm, childOf, asElement) {
      var newElement = document.createElement(/*'span'*/elm);
      if (childOf && !asElement) document.getElementById(childOf).appendChild(newElement);
      else if (childOf) childOf.appendChild(newElement);
      else document.body.appendChild(newElement);
      for (var i = 0; i < Object.keys(attr).length; i++) {
        if (Object.keys(attr)[i] == 'innerText') newElement.innerText = attr[Object.keys(attr)[i]];
        else newElement.setAttribute(Object.keys(attr)[i]/*'style'*/, /*'color:' + word[i].colour*/attr[Object.keys(attr)[i]]);
      }
    }

    /*!
 * Determine if an element is in the viewport
 * (c) 2017 Chris Ferdinandi, MIT License, https://gomakethings.com
 * @param  {Node}    elem The element
 * @return {Boolean}      Returns true if element is in the viewport
 */
 document.onkeydown = function(event) {
   if (event.key == 'Tab' && document.getElementById(selectedElementId.element.toString().split(' ')[0] + ' ' + (JSON.parse(selectedElementId.element.toString().split(' ')[1]) + 1))) {
     setTimeout(function () {
       if (selectedElementId.element.includes('pupilsWriting')) findChild('id', selectedElementId.parent, selectedElementId.element.toString().split(' ')[0] + ' ' + (JSON.parse(selectedElementId.element.toString().split(' ')[1]) + 1)).select();

     }, 10);
   }
}
function replaceAll(str, find, replace) {
    return str.replace(new RegExp(find, 'g'), replace);
}
function addChart(texte, data) {
  // to refresh size (not working otherwise)
  document.getElementById('textur' + selectedElementId.parent).remove();
  addElement({id: 'textur' + selectedElementId.parent}, 'canvas', 'divGraph' + selectedElementId.parent.replace('pupilSheet', ''));
  var data = {
    labels: texte,//["b statt d", "h weggelassen", "t statt l"],
    datasets: [{
      label: "richtige",
      backgroundColor: 'rgba(0, 255, 0, 0.7)',
      borderColor: 'rgba(0, 255, 0, 1)',
      fill: true,
      data: data.right,//[5,3,7],
      stack:'stack0'
    }, {
      label: "falsche",
      backgroundColor: 'rgba(255, 0, 0, 0.7)',
      borderColor: 'rgba(255, 0, 0, 1))',
      fill: true,
      data: data.wrong,
      stack:'stack0'
    }
    ]
  }
  var options = {
    maintainAspectRatio: false,
    responsive: true,
    scales: {
      xAxes: [{
        stacked: true
      }],
      yAxes: [{
        stacked: true,
        ticks: {
          beginAtZero: true
        }
      }],
    },
    // legend: { display: false },
      title: {
        display: true,
        text: 'Schüler Test'
      }
  }
  var myBarChart = new Chart(document.getElementById('textur' + selectedElementId.parent), {
    type: 'horizontalBar',
    data: data,
    options: options
});
document.getElementById('textur' + selectedElementId.parent).onclick = function(evt) {
  console.log("chart");
  var activePoints = myBarChart.getElementsAtEvent(evt);
  if (activePoints[0]) {
    var chartData = activePoints[0]['_chart'].config.data;
    var idx = activePoints[0]['_index'];

    var label = chartData.labels[idx];
    var right = chartData.datasets[0].data[idx];
    var wrong = chartData.datasets[1].data[idx];
    console.log(label + ': ' + right + '/' + (wrong + right) + ' (' + wrong + ' wrong)');
      for (var i = 0; i < neededTest.words.length; i++) {
        findChild('id', selectedElementId.parent, 'correction ' + (i + 1)).style.outlineStyle = "";
        if (label.length == 1 && neededTest.words[i].toLowerCase().includes(label.toLowerCase()) || (label.includes('Silben') && neededTest.words[i].toString().split('-').length == label.replace(' Silben', ''))) {
          findChild('id', selectedElementId.parent, 'correction ' + (i + 1)).style.outlineColor = "red";
          if ((!auswertung.wrongLetters[selectedElementId.parent][replaceAll(neededTest.words[i], '-', '')] || !auswertung.wrongLetters[selectedElementId.parent][replaceAll(neededTest.words[i], '-', '')][label]) && !(label.includes('Silben') && neededTest.words[i].toString().split('-').length == label.replace(' Silben', ''))) findChild('id', selectedElementId.parent, 'correction ' + (i + 1)).style.outlineColor = "green";
          findChild('id', selectedElementId.parent, 'correction ' + (i + 1)).style.outlineStyle = "outset";
          findChild('id', selectedElementId.parent, 'correction ' + (i + 1)).style.width = graphemtrefferPossible[i].getBoundingClientRect().right + 3;
          if (findChild('id', selectedElementId.parent, 'pupilsWriting ' + (i + 1)).value == replaceAll(neededTest.words[i], '-', '')) findChild('id', selectedElementId.parent, 'correction ' + (i + 1)).style.width = 7*replaceAll(neededTest.words[i], '-', '').length;
        }
    }
  }
};
myBarChart.canvas.parentNode.style.height = 1;
// TODO: nicht nur für pupil 1
for (var graphBottom = /*texturpupilSheet1.getBoundingClientRect().bottom*/document.getElementById('divGraph' + selectedElementId.parent.replace('pupilSheet', '')).getBoundingClientRect().bottom; document.getElementById(selectedElementId.parent).getBoundingClientRect().bottom > graphBottom; graphBottom++) {
  myBarChart.canvas.parentNode.style.height = JSON.parse(myBarChart.canvas.parentNode.style.height.replace('px', '')) + 1 + 'px';
}
console.log(myBarChart.canvas.parentNode.style.height);
}
// TODO: document.getElementById('pupilsWriting 1').getBoundingClientRect()
// addChart(['b korrekt', 'h korrekt', 'r korrekt'], {wrong: [1, 1, 1], right: [2, 2, 2]}, texturpupilSheet1);
</script>
