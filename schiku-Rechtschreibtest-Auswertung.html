<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.js"></script>
<select id="textSelctor" onchange="neededTest = words['kreisUnna'][value]; console.log(window.getSelection())">
  <option value="1">Test 1</option>
  <option value="2">Test 2</option>
  <option value="3">Test 3</option>
  <option value="4">Test 4</option>
  <option value="5">Test 5</option>
  <option value="6">Test 6</option>
</select>
<br>
<button type="button" id="addPupil" onclick="addPupil();" name="button">Schüler hinzufügen</button>
<script>
  var words = {kreisUnna: [{kathegorien: ["ku", "2-silben", "3-silben"], words: ["Lama", "Nase", "Hupe", "Rose", "Faden", "Hose", "Hafen", "Salami", "Finale", "Domino", "Kanone", "Pedalen", "Tapete", "Kusine", "Rakete"]}, {kathegorien: ["au", "ei", "sch", "2-silben", "3-silben"], words: ["Haufen", "Anteil", "Ofen", "Einkauf", "Dusche", "Pirat", "Reifen", "Auslauf", "Schein", "Kamin", "Raupe", "Umtausch", "Eisen", "Maschine", "Ende"]}, {kathegorien: ["au", "ei", "ö", "w", "er", "el", "2-silben", "3-silben", "4-silben"], words: ["Wein", "Reiter", "Ampel", "Nadel", "Eimer", "Ausweis", "Döner", "Schönheit", "Alter", "Lederhose", "Melonenschale", "Nudelsalat", "Modenschau", "Kilometer", "Möwenfeder"]}, {kathegorien: ["au", "ei", "ö", "ü", "g", "b", "er", "2-silben", "3-silben", "4-silben"], words: ["Geige", "Bauer", "Eule", "Segel", "Biber", "Beutel", "Gabel", "Gemüse", "Scheunentor", "Geheimtür", "Möbelwagen", "Bügeleisen", "Lebewesen", "Gemeinheit", "Ofenfeuer"]}, {kathegorien: [], words: ["Badewanne", "Regenmantel", "Perlenkette", "Hasenfelle", "Waschbecken", "Rabenfeder", "Melonenkerne", "Waffeleisen", "Lassowerfer", "Möbelpacker",
"Scherbenhaufen", "Lebewesen", "Kellerecke", "Tafellappen", "Lampenschalter"]}, {kathegorien: [], words: ["Hinweisschilder", "Lieferwagen", "Winterwetter", "Schiebetür", "Gewitterhimmel",
"Wickeltisch", "Geheimnisse", "Tintenkiller", "Liegewiese", "Unterkiefer", "Rinderherde", "Liebeslieder", "Regenrinne", "Kinderwippe"]}, {kathegorien: [], words: ["Sonderangebote", "Hundefutter", "Soldatenrufe", "Kartoffelsorte", "Buckelwale", "Butterdose", "Eisscholle", "Regentonne", "Schulterwunde", "Nudelsuppe", "Wintersocken", "Fischkutter"]}, {kathegorien: [], words: ["Salatschüssel", "Raketenböller", "Körperteil", "Regenwürmer", "Hundehütte", "Kamelhöcker", "Dönerbude", "Suppenlöffel", "Damenhüte", "Füllertinte", "Schülerwünsche", "Wörterliste", "Rückennummer", "Löwenköpfe"]}]};
var neededTest = words['kreisUnna'][0];
var pupils = 0;
var selectedElementId = {parent: 'pupilSheet1', element: 'pupilsWriting 1'};
/*
* PURPOSE : fügt die Elemente für einen neuen Schüler hinzu
*/
function addPupil() {
  pupils++;
  addElement({id: 'pupilSheet' + pupils, style: 'width:21cm; height:29.7cm'}, 'div');
  addElement({placeholder: 'Name Schüler'}, 'input', 'pupilSheet' + pupils);
  addElement({placeholder: 'Klasse'}, 'input', 'pupilSheet' + pupils);
  addElement({}, 'br', 'pupilSheet' + pupils);
  for (var i = 0; i < neededTest.words.length; i++) {
    addElement({innerText: neededTest.words[i], id: 'word ' + (i + 1)}, 'a', 'pupilSheet' + pupils);
    addElement({id: 'pupilsWriting ' + (i + 1), class: 'writingPupilSheet' + pupils, placeholder: 'Schreibung Schüler', oninput: 'markErrors(id, "pupilSheet' + pupils + '");', onchange: 'pupilsWritingFinished(id);', title: 'Die Eingabe wird automatisch "korregiert". \nFalls die automatische Korrektur Fehler enthalten sollte, können sie die Anzahl der Graphemtreffer korregieren.\nWenn der Schüler das Wort komplett richtig geschrieben hat, geben sie nur "r" für richtig ein!'}, 'input', 'pupilSheet' + pupils);
    addElement({id: 'correction ' + (i + 1)}, 'div', 'pupilSheet' + pupils);

    addElement({}, 'br', 'pupilSheet' + pupils);

  }
  addElement({id: 'allGraphemes' + pupils, style: 'font-size: 30'}, 'a', 'pupilSheet' + pupils);
  addElement({}, 'br', 'pupilSheet' + pupils);
  addElement({id: 'texturpupilSheet' + pupils}, 'canvas', 'pupilSheet' + pupils);
  addElement({}, 'br', 'pupilSheet' + pupils);
}
function findChild(idOfElement, idOfChild, elementNotId){
  if (!elementNotId) var element = document.getElementById(idOfElement);
  else var element = idOfElement;
  return element.querySelector('[id="' + idOfChild + '"]');
}
function pupilsWritingFinished(id) {
  if (document.getElementById(id).value == "r") {
    document.getElementById(id).value = findChild(selectedElementId.parent, "word " + id.replace("pupilsWriting ", "")).innerText;
    markErrors(id, "pupilSheet1", true);
}
}
var auswertung = {allGraphemtreffer: {possible: 0, got: 0}};
function markErrors(id, parentId, doNotMark) {
  selectedElementId = {parent: parentId, element: id};
  var correct = findChild(selectedElementId.parent, 'word ' + id.replace('pupilsWriting ', '')).innerText;
  var wrong = findChild(selectedElementId.parent, 'pupilsWriting ' + id.replace('pupilsWriting ', '')).value;
  var wrongI = 0;
  var newWord = [];
  var addI = 0;
  var doubleError = 0;
  var graphemFeler = 0;
  var wordCorrectionChild = findChild(selectedElementId.parent, 'correction ' + id.replace('pupilsWriting ', ''));
  for (var i = 0; findChild(wordCorrectionChild, 'correctionLetter', true); i++) {
    findChild(wordCorrectionChild, 'correctionLetter', true).remove();
  }
  try {
    findChild(wordCorrectionChild, 'graphemtrefferGot', true).remove();
    findChild(wordCorrectionChild, 'graphemtrefferPossible', true).remove();
    findChild(wordCorrectionChild, 'graphemtrefferSlash', true).remove();
  } catch (e) {console.log(e);}
  for (var i = 0; i < wrong.length; i++) {
    newWord.push({letter: wrong[i], colour: "white"});
  }
  for (var i = 0; i < correct.length && wrong[i]; i++) {
    // check letter difference
    if (correct[i] != wrong[wrongI] && (!wrong[wrongI + 1] || (wrong[wrongI + 1] && wrong[wrongI + 1] != correct[i]))) {
      if ((/*wrong[wrongI] == wrong[wrongI].toLowerCase() || */correct[i].toLowerCase() != wrong[wrongI].toLowerCase()/*capitalizeFirstLetter(correct[i]) == correct[i]*/)/* && !(capitalizeFirstLetter(correct[i]) == correct[i] && correct[i].toLowerCase() == wrong[wrongI].toLowerCase())*/) graphemFeler++;
      console.log(correct[i] + " before " + wrong[wrongI]);
      // check if letter missing
      if ((!wrong[wrongI + 1] && (!wrong[wrongI] || wrong[wrongI].toLowerCase() != correct[i + 1])) || (wrong[wrongI + 1] && wrong[wrongI + 1].toLowerCase() == correct[i + 1])) {
        console.log("remove " + wrong[wrongI] + " pos. " + wrongI);
        if (newWord[wrongI + addI]) newWord[wrongI + addI].colour = "#FD6441/*red*/";
        wrongI++;

        // check if doubleError
        if (wrong[wrongI - 2] == wrong[wrongI - 1]) {
          newWord.splice(wrongI + addI, 0, {letter: '_', colour: "white"});
          addI++;
          doubleError++;
        }
}
else {
  newWord.splice(wrongI + addI, 0, {letter: '_', colour: "white"});
  addI++;
  // graphemFeler++;
}
    }
    else if (((wrong[wrongI + 1] && wrong[wrongI + 1] == correct[i])) && correct[i] != wrong[wrongI]) {
      console.log("remove " + wrong[wrongI] + " pos. " + wrongI);
      newWord[wrongI + addI].colour = "#FD6441/*red*/";
      // not sure about this [todo]
      doubleError++;
      i--;
    }
    if (!(correct[i] != wrong[wrongI] && (!wrong[wrongI + 1] || wrongI > i || (wrong[wrongI + 1] && wrong[wrongI + 1] != correct[i]))) || (wrong[wrongI + 1] && wrong[wrongI + 1].toLowerCase() == correct[i + 1])) wrongI++;
  }
  // check end missing
  for (var i = i; newWord.length - doubleError < correct.length; i++) {
    newWord.push({letter: '_', colour: "white"});
    graphemFeler++;
  }
  // check too much in the end
  for (var i = wrongI + addI; i < newWord.length && i >= correct.length; i++) {
    console.log("remove " + wrong[i]);
    if (newWord[i].letter != '_') {newWord[i].colour = "#FD6441/*red*/"; graphemFeler++;}
  }
  console.log(newWord);
  for (var i = 0; i < newWord.length && !doNotMark && graphemFeler > 0; i++) {
    addElement({id: 'correctionLetter', innerText: newWord[i].letter, style: 'background-color:' + newWord[i].colour + ';'/* + id.replace('pupilsWriting ', '')*/}, 'span', /*'correction ' + id.replace('pupilsWriting ', '')*/wordCorrectionChild, true);
  }
  if (!doNotMark && graphemFeler > 0) {
    addElement({value: correct.length - graphemFeler, id: 'graphemtrefferGot', oninput: 'getAllGraphemtreffer();', class: 'graphemtrefferGot' + capitalizeFirstLetter(selectedElementId.parent), style: 'width: 25;'}, 'input', wordCorrectionChild, true);
    addElement({innerText: '/', id: 'graphemtrefferSlash', style: 'width: 25;'}, 'a', wordCorrectionChild, true);
    addElement({value: correct.length, id: 'graphemtrefferPossible', oninput: 'getAllGraphemtreffer();', class: 'graphemtrefferPossible' + capitalizeFirstLetter(selectedElementId.parent), style: 'width: 25;'}, 'input', wordCorrectionChild, true);
    findChild(selectedElementId.parent, id).style.backgroundColor = "red";
  }
  else {
    addElement({style: 'display: none;', value: correct.length - graphemFeler, id: 'graphemtrefferGot', class: 'graphemtrefferGot' + capitalizeFirstLetter(selectedElementId.parent)}, 'input', wordCorrectionChild, true);
    addElement({style: 'display: none;', value: correct.length, id: 'graphemtrefferPossible', class: 'graphemtrefferPossible' + capitalizeFirstLetter(selectedElementId.parent)}, 'input', wordCorrectionChild, true);
    findChild(selectedElementId.parent, id).style.backgroundColor = "green";
  }
  getAllGraphemtreffer(doNotMark, graphemFeler, correct);
}
function getAllGraphemtreffer(/*doNotMark, graphemFeler, correct*/) {
  auswertung.allGraphemtreffer.possible = 0;
  auswertung.allGraphemtreffer.got = 0;
  for (var i = 0; i < document.getElementsByClassName("graphemtrefferGot" + capitalizeFirstLetter(selectedElementId.parent)).length; i++) {
    auswertung.allGraphemtreffer.possible += JSON.parse(document.getElementsByClassName("graphemtrefferPossible" + capitalizeFirstLetter(selectedElementId.parent))[i].value);
    auswertung.allGraphemtreffer.got += JSON.parse(document.getElementsByClassName("graphemtrefferGot" + capitalizeFirstLetter(selectedElementId.parent))[i].value);
  }
  document.getElementById('allGraphemes' + selectedElementId.parent.toString().split('Sheet')[1]).innerText = 'gesamt ' + auswertung.allGraphemtreffer.got + '/' + auswertung.allGraphemtreffer.possible;
}
function getEveryCategory() {
  for (var i = 0; i < neededTest.kathegorien.length; i++) {
    auswertung[neededTest.kathegorien[i]] = {got: 0, possible: 0};
    if (neededTest.kathegorien[i].includes('silben')) {
      for (var i1 = 0; i1 <  document.getElementsByClassName('writing' + capitalizeFirstLetter(selectedElementId.parent)).length; i1++) {
        if (new_count(neededTest.words[i1]) == neededTest.kathegorien[i].replace('-silben', '') && neededTest.words[i1].toLowerCase() == document.getElementsByClassName('writing' + capitalizeFirstLetter(selectedElementId.parent))[i1].value.toLowerCase()) {
          auswertung[neededTest.kathegorien[i]].got++;
        }
        auswertung[neededTest.kathegorien[i]].possible++;
      }
    }
  }
  console.log(auswertung);
}
function capitalizeFirstLetter(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
}

/*
 * PURPOSE : generiert ein neues HTML Element
 *  PARAMS : attr - Attribute des Elements
 *           elm - Typ des Elements
 *           childOf - in welchem welches HTML Element soll das neue eingefügt werden? (wenn nicht angegeben wird es ganz außen unten eingefügt)
 */
  function addElement(attr, elm, childOf, asElement) {
      var newElement = document.createElement(/*'span'*/elm);
      if (childOf && !asElement) document.getElementById(childOf).appendChild(newElement);
      else if (childOf) childOf.appendChild(newElement);
      else document.body.appendChild(newElement);
      for (var i = 0; i < Object.keys(attr).length; i++) {
        if (Object.keys(attr)[i] == 'innerText') newElement.innerText = attr[Object.keys(attr)[i]];
        else newElement.setAttribute(Object.keys(attr)[i]/*'style'*/, /*'color:' + word[i].colour*/attr[Object.keys(attr)[i]]);
      }
    }

    /*!
 * Determine if an element is in the viewport
 * (c) 2017 Chris Ferdinandi, MIT License, https://gomakethings.com
 * @param  {Node}    elem The element
 * @return {Boolean}      Returns true if element is in the viewport
 */
 document.onkeydown = function(event) {
   if (event.key == 'Tab' && document.getElementById(selectedElementId.element.toString().split(' ')[0] + ' ' + (JSON.parse(selectedElementId.element.toString().split(' ')[1]) + 1))) {
     setTimeout(function () {
       findChild(selectedElementId.parent, selectedElementId.element.toString().split(' ')[0] + ' ' + (JSON.parse(selectedElementId.element.toString().split(' ')[1]) + 1)).select();
     }, 10);
   }
}
function addChart(texte, data, canvas) {
  var data = {
    labels: texte,//["b statt d", "h weggelassen", "t statt l"],
    datasets: [{
      label: "richtige",
      backgroundColor: 'rgba(0, 255, 0, 0.7)',
      borderColor: 'rgba(0, 255, 0, 1)',
      fill: true,
      data: data.right,//[5,3,7],
      stack:'stack0'
    }, {
      label: "falsche",
      backgroundColor: 'rgba(255, 0, 0, 0.7)',
      borderColor: 'rgba(255, 0, 0, 1))',
      fill: true,
      data: data.wrong,
      stack:'stack0'
    }
    ]
  }
  var options = {
    maintainAspectRatio: false,
    scales: {
      xAxes: [{
        stacked: true
      }],
      yAxes: [{
        stacked: true,
        ticks: {
          beginAtZero: true
        }
      }],
    },
    // legend: { display: false },
      title: {
        display: true,
        text: 'Schüler Test'
      }
  }
  var myBarChart = new Chart(canvas, {
    type: 'horizontalBar',
    data: data,
    options: options
});
}
</script>
