<meta charset="utf-8">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
<select id="testTypeSelector">
  <option value="Kreis Unna">Kreis Unna</option>
  <option value="newTestType">+ Test Typ</option>
</select>
<button type="button" onclick="copyCode();" name="button">Code in die Zwischenablage kopieren</button>
<button type="button" style="display: none" id="syncWithOfficialDataButton" onclick="syncWithOfficialData();" title="bleibt gespeichert, aber wenn sich beim Offiziellen was ändert, wird das nich automatisch synchronisiert." name="button">einmalig mit offiziellen Daten überschreiben</button>
<input id="syncDataCheckbox" onchange="localStorage.setItem('syncWithOfficials', checked); syncWithOfficialData(true); refreshWords();" type="checkbox"> immer mit offiziellen Daten überschreiben
<input type="text" id="message" style="display: none">
<br>
<select id="testSelctor" onchange="neededTest = words['Kreis Unna'][value]; console.log(window.getSelection())">
  <option value="Test 1">Test 1</option>
  <option value="Test 2">Test 2</option>
  <option value="Test 3">Test 3</option>
  <option value="Test 4">Test 4</option>
  <option value="Test 5">Test 5</option>
  <option value="Test 6">Test 6</option>
  <option value="newTest">+ Test</option>
</select>
<button type="button" onclick="editTest();" name="button">edit</button>
<br>
<div id="tests">
  <button type="button" id="addPupil" onclick="addPupil();" name="button">Schüler hinzufügen</button>
</div>
<div id="editor" style="display: none">
  <input type="text" id="nameType" placeholder="Name Testart">
  <input type="text" id="nameTest" placeholder="Name expliziter Test">
  <br>
  <br>
<div id="words"></div>
<button type="button", id="removeWord" onclick="removeWord();" name="button">X</button>
<button type="button" onclick="addWord('', document.getElementsByClassName('word').length);" style='width: 147px; height: 20' id="addWord">+ Wort</button>
<br>
<button type="button" style="width: 175" onclick="saveAndCloseEditor();" name="button">auf dem Gerät speichern und verlassen</button>
</div>
<script>
  var officialData = {"Kreis Unna": {"Test 1": {kathegorien: ["ku", "2 Silben", "3 Silben"], words: ["La-ma", "Na-se", "Hu-pe", "Ro-se", "Fa-den", "Ho-se", "Ha-fen", "Sa-la-mi", "Fi-na-le", "Do-mi-no", "Ka-no-ne", "Pe-da-len", "Ta-pe-te", "Ku-si-ne", "Ra-ke-te"]}, "Test 2": {kathegorien: ["au", "ei", "sch", "2 Silben", "3 Silben"], words: ["Hau-fen", "An-teil", "O-fen", "Ein-kauf", "Du-sche", "Pi-rat", "Rei-fen", "Aus-lauf", "Schein", "Ka-min", "Rau-pe", "Um-tausch", "Ei-sen", "Ma-schi-ne", "En-de"]}, "Test 3": {kathegorien: ["au", "ei", "ö", "w", "er", "el", "2 Silben", "3 Silben", "4 Silben"], words: ["Wein", "Rei-ter", "Am-pel", "Na-del", "Ei-mer", "Aus-weis", "Dö-ner", "Schön-heit", "Al-ter", "Le-der-ho-se", "Me-lo-nen-scha-le", "Nu-del-sa-lat", "Mo-den-schau", "Ki-lo-me-ter", "Mö-wen-fe-der"]}, "Test 4": {kathegorien: ["au", "ei", "ö", "ü", "g", "b", "er", "2 Silben", "3 Silben", "4 Silben"], words: ["Gei-ge", "Bau-er", "Eu-le", "Se-gel", "Bi-ber", "Beu-tel", "Ga-bel", "Ge-mü-se", "Scheu-nen-tor", "Ge-heim-tür", "Mö-bel-wa-gen", "Bü-gel-ei-sen", "Le-be-we-sen", "Ge-mein-heit", "O-fen-feu-er"]}, "Test 5": {kathegorien: [], words: ["Ba-de-wan-ne", "Re-gen-man-tel", "Per-len-ket-te", "Ha-sen-fel-le", "Wasch-be-cken", "Ra-ben-fe-der", "Me-lo-nen-ker-ne", "Waf-fel-ei-sen", "Las-so-wer-fer", "Mö-bel-pa-cker",
"Scher-ben-hau-fen", "Le-be-we-sen", "Kel-ler-e-cke", "Ta-fel-lap-pen", "Lam-pen-schal-ter"]}, "Test 6": {kathegorien: [], words: ["Hin-weis-schil-der", "Lie-fer-wa-gen", "Win-ter-wet-ter", "Schie-be-tür", "Ge-wit-ter-him-mel",
"Wi-ckel-tisch", "Ge-heim-nis-se", "Tin-ten-kil-ler", "Lie-ge-wie-se", "Un-ter-kie-fer", "Rin-der-her-de", "Lie-bes-lie-der", "Re-gen-rin-ne", "Kin-der-wip-pe"]}, "Test 7": {kathegorien: [], words: ["Son-der-an-ge-bo-te", "Hun-de-fut-ter", "Sol-da-ten-ru-fe", "Kar-tof-fel-sor-te", "Bu-ckel-wa-le", "But-ter-do-se", "Eis-schol-le", "Re-gen-ton-ne", "Schul-ter-wun-de", "Nu-del-sup-pe", "Win-ter-soc-ken", "Fisch-kut-ter"]}, "Test 8": {kathegorien: [], words: ["Sa-lat-schüs-sel", "Ra-ke-ten-böl-ler", "Kör-per-teil", "Re-gen-wür-mer", "Hun-de-hüt-te", "Ka-mel-hö-cker", "Dö-ner-bu-de", "Sup-pen-löf-fel", "Da-men-hü-te", "Fül-ler-tin-te", "Schü-ler-wün-sche", "Wör-ter-lis-te", "Rü-cken-num-mer", "Lö-wen-köp-fe"]}}};
var words = officialData;
var neededTest = words['Kreis Unna']["Test 1"];
var pupils = 0;
var selectedElementId = {parent: 'pupilSheet1', element: 'pupilsWriting 1'};
var myBarChart = [];
function editTest() {
  while (document.getElementsByClassName("word").length > 0) {
    document.getElementsByClassName("word")[0].remove();
    document.getElementsByClassName("br")[0].remove();
  }
  tests.style.display = "none";
  editor.style.display = "inline";
  for (var i = 0;  testTypeSelector.value != "newTestType" && testSelctor.value != "newTest" && i < neededTest.words.length; i++) {
    addWord(neededTest.words[i], i);
  }
if (testTypeSelector.value != "newTestType") {
  nameType.value = testTypeSelector.value;
  if (testSelctor.value != "newTest") {
    nameTest.value = testSelctor.value;
  }
}
if (testTypeSelector.value == "newTestType" || testSelctor.value == "newTest") addWord('', 0);
}
function saveAndCloseEditor() {
  if (!words[nameType.value][nameTest.value]) nameTest.value = nameTest.value;
  if (!words[nameType.value]) words[nameType.value] = {};
  words[nameType.value][nameTest.value] = {words: [], kathegorien: []};
  for (var i = 0; i < document.getElementsByClassName("word").length; i++) {
    words[nameType.value][nameTest.value].words.push(document.getElementsByClassName("word")[i].value);
  }
  editor.style.display = 'none';
  tests.style.display = 'inline';
  localStorage.setItem('words', JSON.stringify(words));
  refreshWords();
}
function refreshWords() {
  while (document.getElementById('testTypeSelector').options.length > 0) {
    document.getElementById('testTypeSelector').options[0] = undefined;
  }
  while (document.getElementById('testSelctor').options.length > 0) {
    document.getElementById('testSelctor').options[0] = undefined;
  }
  for (var i = 0; i < Object.keys(words).length; i++) {
    var nameTypeNow = Object.keys(words)[i];
    addElement({value: nameTypeNow, innerText: nameTypeNow}, 'option', 'testTypeSelector');
    for (var i1 = 0; i1 < Object.keys(words[nameTypeNow]).length; i1++) {
      var nameTestNow = Object.keys(words[nameTypeNow])[i1];
      addElement({value: nameTestNow, innerText: nameTestNow}, 'option', 'testSelctor');
    }
  }
  addElement({value: 'newTestType', innerText: '+ Test Typ'}, 'option', 'testTypeSelector');
  addElement({value: 'newTest', innerText: '+ Test'}, 'option', 'testSelctor');

  while (pupils > 0) {
    document.getElementById('pupilSheet' + pupils).remove();
    pupils--;
  }
  recreatePupils();
}
function copyCode() {
document.getElementById('message').style.display = "inline";
var copytext;
document.getElementById("message").value = replaceAll( replaceAll( replaceAll( replaceAll( replaceAll(JSON.stringify(words), '"kathegorien"', 'kathegorien'), '"words"', 'words' ),  '"words"', 'words'),  ':', ': '), ',', ', ');
copytext = document.getElementById("message")

copytext.select();

try{

successful = document.execCommand("copy")
message = successful ? "successful" : "unsuccessful"
}


catch(err){
document.getElementById("message").value = "Ein Fehler ist aufgetreten!!!"
}
document.getElementById('message').style.display = "none";
}
function addWord(value, i) {
  addElement({class: 'word', placeholder: 'Wort', value: value, title: 'Silben mit Bindestrich abtrennen.'}, 'input', 'words');
  addElement({class: 'br'}, 'br', 'words');
}
function removeWord() {
  document.getElementsByClassName('word')[document.getElementsByClassName('word').length - 1].remove();
  document.getElementsByClassName('br')[document.getElementsByClassName('br').length - 1].remove();
}
/*
* PURPOSE : fügt die Elemente für einen neuen Schüler hinzu
*/
document.getElementById('addPupil').style.left = 300 + "px";
document.getElementById('addPupil').style.position = 'fixed'
function addPupil() {
  pupils++;
  addElement({id: 'pupilSheet' + pupils, style: 'width:21cm; height:29.7cm'}, 'div');
  addElement({placeholder: 'Name Schüler', id: 'name', oninput: 'selectedElementId.element = id; selectedElementId.parent = "pupilSheet' + pupils + '"; dataChanged(id, value);'}, 'input', 'pupilSheet' + pupils);
  addElement({placeholder: 'Klasse', id: 'class' + pupils, style: 'width: 50;', oninput: 'selectedElementId.element = id; selectedElementId.parent = "pupilSheet' + pupils + '"; dataChanged(id, value);'}, 'input', 'pupilSheet' + pupils);
  addElement({}, 'br', 'pupilSheet' + pupils);
  addElement({placeholder: 'Datum', style: 'width: 226;', id: 'date' + pupils, oninput: 'selectedElementId.element = id; selectedElementId.parent = "pupilSheet' + pupils + '"; dataChanged(id, value);'}, 'input', 'pupilSheet' + pupils);
  addElement({placeholder: 'Anmerkungen', style: 'position: absolute; right: 0px; height: 20px'/*50px*/, id: 'comment', oninput: 'selectedElementId.element = id; selectedElementId.parent = "pupilSheet' + pupils + '"; dataChanged(id, value);'}, 'textarea', 'pupilSheet' + pupils);
  addElement({id: 'divGraph' + pupils, style: 'position: absolute; right: 0px;'}, 'div', 'pupilSheet' + pupils);
  addElement({id: 'texturpupilSheet' + pupils}, 'canvas', 'divGraph' + pupils);
  addElement({}, 'br', 'pupilSheet' + pupils);
  for (var i = 0; i < neededTest.words.length; i++) {
    addElement({innerText: replaceAll(neededTest.words[i], '-', ''), id: 'word ' + (i + 1)}, 'a', 'pupilSheet' + pupils);
    addElement({id: 'pupilsWriting ' + (i + 1), style: '  color: white;', class: 'writingPupilSheet' + pupils, placeholder: 'Schreibung Schüler', oninput: 'markErrors(id, "pupilSheet' + pupils + '");', onchange: 'pupilsWritingFinished(id);', title: 'Die Eingabe wird automatisch "korrigiert". \nFalls die automatische Korrektur Fehler enthalten sollte, können Sie die Anzahl der Graphemtreffer korrigieren.\nWenn der Schüler das Wort komplett richtig geschrieben hat, geben Sie nur "r" für richtig ein!'}, 'input', 'pupilSheet' + pupils);
    addElement({id: 'correction ' + (i + 1), word: replaceAll(neededTest.words[i], '-', '')}, 'div', 'pupilSheet' + pupils);
    if (i != neededTest.words.length - 1) addElement({}, 'br', 'pupilSheet' + pupils);
  }
  addElement({id: 'allGraphemes' + pupils, style: 'font-size: 30'}, 'a', 'pupilSheet' + pupils);
  // addElement({}, 'br', 'pupilSheet' + pupils);
  // addElement({}, 'br', 'pupilSheet' + pupils);
}
function findChild(childType, idOfElement, idOfChild, elementNotId){
  if (!elementNotId) var element = document.getElementById(idOfElement);
  else var element = idOfElement;
  return element.querySelector('[' + childType + '="' + idOfChild + '"]');
}
function pupilsWritingFinished(id, restoringData) {
  if (findChild('id', selectedElementId.parent, id) && findChild('id', selectedElementId.parent, id).value == "r") {
    findChild('id', selectedElementId.parent, id).value = findChild('id', selectedElementId.parent, "word " + id.replace("pupilsWriting ", "")).innerText;
    markErrors(id, selectedElementId.parent, true, restoringData);
  }
  if (!restoringData) getEveryCategory();
}
function syncWithOfficialData(sync) {
  for (var i = 0; i < Object.keys(officialData).length; i++) {
    var nameTypeNow = Object.keys(officialData)[i];
    for (var i1 = 0; i1 < Object.keys(officialData[nameTypeNow]).length; i1++) {
      var nameTestNow = Object.keys(officialData[nameTypeNow])[i1];
      if (sync) words[nameTypeNow][nameTestNow] = officialData[nameTypeNow][nameTestNow];
      else if (!angular.equals(words[nameTypeNow][nameTestNow], officialData[nameTypeNow][nameTestNow])) syncWithOfficialDataButton.style.display = 'inline';
    }
  }
  localStorage.setItem('words', JSON.stringify(words));
}
var auswertung = {allGraphemtreffer: {possible: 0, got: 0}, wrongLetters: {}, letter: {}};
var inputs = {};
if (localStorage.getItem('words') != "undefined" && localStorage.getItem('words')) {
  var wordsInport = JSON.parse(localStorage.getItem('words'));
  for (var i = 0; i < Object.keys(words).length; i++) {
    var nameTypeNow = Object.keys(words)[i];
    if (!(Object.keys(wordsInport).includes(nameTypeNow))) wordsInport[nameTypeNow] = words[nameTypeNow];
    for (var i1 = 0; i1 < Object.keys(words[nameTypeNow]).length; i1++) {
      var nameTestNow = Object.keys(words[nameTypeNow])[i1];
      if (!(Object.keys(wordsInport[nameTypeNow]))) wordsInport[nameTypeNow][nameTest] = words[nameTypeNow][nameTestNow];
    }
  }
  words = wordsInport;
  refreshWords();
}
if (localStorage.getItem('syncWithOfficials') == "undefined" || !localStorage.getItem('syncWithOfficials') || localStorage.getItem('syncWithOfficials') == "false") syncWithOfficialData();
else {
  syncWithOfficialData(true);
  syncDataCheckbox.checked = true;
}
if (localStorage.getItem('inputsSchiku') && localStorage.getItem('inputsSchiku') != 'undefined' && confirm('Wollen Sie zuletzt ausgefüllten Tests wiederherstellen? Wenn Sie auf abbrechen oder cancel klicken wird der Fortschritt verloren gehen.')) inputs = JSON.parse(localStorage.getItem('inputsSchiku'));
else if (!localStorage.getItem('inputsSchiku') || localStorage.getItem('inputsSchiku') == 'undefined' || confirm('Wenn Sie auf OK klicken gehen alle gespeicherten Eingaben von diesem Gerät verloren! Wollen Sie wirklich forfahren?')) localStorage.setItem('inputsSchiku', 'undefined');
else if (localStorage.getItem('inputsSchiku') || localStorage.getItem('inputsSchiku') != 'undefined') inputs = JSON.parse(localStorage.getItem('inputsSchiku'));
recreatePupils();
function recreatePupils() {
  selectedElementId.parent = 'pupilSheet1';
  for (var i3 = 0; i3 < Object.keys(inputs).length; i3++) {
    var testAktuell = Object.keys(inputs)[i3];
    neededTest = words['Kreis Unna'][testAktuell];
    testSelctor.value = testAktuell;//.replace('Test ', '');
  for (var i = 0; i < Object.keys(inputs[testAktuell]).length; i++) {
    addPupil();
    var sheetAktuell = Object.keys(inputs[testAktuell])[i];
    var minusI = 0;
    for (var i1 = 0; i1 < Object.keys(inputs[testAktuell][ Object.keys(inputs[testAktuell])[i]]).length; i1++) {
      var idAktuell = Object.keys(inputs[testAktuell][ Object.keys(inputs[testAktuell])[i]])[i1];
      if (!(idAktuell.includes('mirror'))) {
      if (idAktuell.includes('pupilsWriting') && findChild('id', sheetAktuell, idAktuell)) {
      findChild('id', sheetAktuell, idAktuell).value = inputs[testAktuell][sheetAktuell][idAktuell];
      markErrors(idAktuell, sheetAktuell, undefined, true);
      pupilsWritingFinished(idAktuell, true);
    }
    else if (findChild('id', sheetAktuell, idAktuell)) {
      findChild('id', sheetAktuell, idAktuell).value = inputs[testAktuell][sheetAktuell][ idAktuell];
      minusI++;
    }
    pupilsWritingFinished(idAktuell, true);
  }
  }
  for (var i2 = 0; inputs[testAktuell][sheetAktuell].mirror && i2 < Object.keys(inputs[testAktuell][sheetAktuell].mirror).length; i2++) {
    for (var i4 = 0; i4 < inputs[testAktuell][sheetAktuell].mirror[Object.keys(inputs[testAktuell][sheetAktuell].mirror)[i2]].length; i4++) {
      if (inputs[testAktuell][sheetAktuell].mirror[Object.keys(inputs[testAktuell][sheetAktuell].mirror)[i2]][i4]) {
      // findChild('word', sheetAktuell, Object.keys(inputs[testAktuell][sheetAktuell].mirror)[i2][i2]);
      findChild('class', findChild('word', sheetAktuell, Object.keys(inputs[testAktuell][sheetAktuell].mirror)[i2]), 'correctionLetter' + i4, true).style.backgroundColor = '#00BFFF';
    }
    }
  }
  pupilsWritingFinished(idAktuell);
    makeTextboxBigger();
  }
  }
}
  function makeTextboxBigger() {
    findChild('id', selectedElementId.parent, 'comment').scroll(0, 1000);
    while (findChild('id', selectedElementId.parent, 'comment').scrollTop > 0) {
      findChild('id', selectedElementId.parent, 'comment').style.height = JSON.parse(findChild('id', selectedElementId.parent, 'comment').style.height.replace('px', '')) + 1 + 'px';
      document.getElementById('divGraph' + selectedElementId.parent.replace('pupilSheet', '')).style.top = JSON.parse(document.getElementById('divGraph' + selectedElementId.parent.replace('pupilSheet', '')).style.top.replace('px', '')) + 1 + 'px';
      document.getElementById('divGraph' + selectedElementId.parent.replace('pupilSheet', '')).style.height = JSON.parse(document.getElementById('divGraph' + selectedElementId.parent.replace('pupilSheet', '')).style.height.replace('px', '')) - 1 + 'px';
    }
  }
function dataChanged(id, value) {
  if (!inputs[/*'Test ' + */testSelctor.value]) inputs[/*'Test ' + */testSelctor.value] = {};
  if (!inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent]) inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent] = {};
  inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent][id] = value;
  localStorage.setItem('inputsSchiku', JSON.stringify(inputs));
  if (id == "comment") {
    makeTextboxBigger();
  }
}
function addWrongLetter(correct, i) {
  try {
    graphemFehler++;
    var currentLetter = correct[i].toLowerCase();
    if (currentLetter == "e" && i == correct.length - 1) currentLetter = '<' + currentLetter + '>';
    if (!auswertung.wrongLetters[selectedElementId.parent]) auswertung.wrongLetters[selectedElementId.parent] = {};
    if (!auswertung.wrongLetters[selectedElementId.parent][correct]) auswertung.wrongLetters[selectedElementId.parent][correct] = {};
    if (!auswertung.wrongLetters[selectedElementId.parent][correct][currentLetter]) auswertung.wrongLetters[selectedElementId.parent][correct][currentLetter] = 0;
    auswertung.wrongLetters[selectedElementId.parent][correct][currentLetter]++;
  } catch (e) {}
}
var graphemFehler = 0;
window.scroll(0, 10000);
function markErrors(id, parentId, doNotMark, doNotResetMirror) {
  if (!inputs[/*'Test ' + */testSelctor.value]) inputs[/*'Test ' + */testSelctor.value] = {};
  if (!inputs[/*'Test ' + */testSelctor.value][parentId]) inputs[/*'Test ' + */testSelctor.value][parentId] = {};
  inputs[/*'Test ' + */testSelctor.value][parentId][id] = findChild('id', selectedElementId.parent, id).value;
  localStorage.setItem('inputsSchiku', JSON.stringify(inputs));
  selectedElementId = {parent: parentId, element: id};
  var correct = findChild('id', selectedElementId.parent, 'word ' + id.replace('pupilsWriting ', '')).innerText;
  var wrong = findChild('id', selectedElementId.parent, 'pupilsWriting ' + id.replace('pupilsWriting ', '')).value;
  var wrongI = 0;
  if (!doNotResetMirror && inputs[/*'Test ' + */testSelctor.value] && inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent] && inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror) inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror[correct] = [];
  if (auswertung.wrongLetters[selectedElementId.parent]) auswertung.wrongLetters[selectedElementId.parent][correct] = {};
  var newWord = [];
  var addI = 0;
  var doubleError = 0;
  graphemFehler = 0;
  var wordCorrectionChild = findChild('id', selectedElementId.parent, 'correction ' + id.replace('pupilsWriting ', ''));
  for (var i = 0; findChild('id', wordCorrectionChild, 'correctionLetter', true); i++) {
    findChild('id', wordCorrectionChild, 'correctionLetter', true).remove();
  }
  try {
    findChild('id', wordCorrectionChild, 'graphemtrefferGot', true).remove();
    findChild('id', wordCorrectionChild, 'graphemtrefferPossible', true).remove();
    findChild('id', wordCorrectionChild, 'graphemtrefferSlash', true).remove();
  } catch (e) {console.log(e);}
  for (var i = 0; i < wrong.length; i++) {
    newWord.push({letter: wrong[i], colour: "white"});
  }
  for (var i = 0; i < correct.length && wrong[wrongI]; i++) {
    // check letter difference: following letter wrong
    if (correct[i] != wrong[wrongI] && (!wrong[wrongI + 1] || (wrong[wrongI + 1] && wrong[wrongI + 1] != correct[i]))) {
      if ((/*wrong[wrongI] == wrong[wrongI].toLowerCase() || */correct[i].toLowerCase() != wrong[wrongI].toLowerCase()/*capitalizeFirstLetter(correct[i]) == correct[i]*/)/* && !(capitalizeFirstLetter(correct[i]) == correct[i] && correct[i].toLowerCase() == wrong[wrongI].toLowerCase())*/) {
        addWrongLetter(correct, i);
      }
      // console.log(correct[i] + " before " + wrong[wrongI]);
      // check if letter missing
      if ((!wrong[wrongI + 1] && (!wrong[wrongI] || wrong[wrongI].toLowerCase() != correct[i + 1])) || (wrong[wrongI + 1] && wrong[wrongI + 1].toLowerCase() == correct[i + 1])) {
        // console.log("remove " + wrong[wrongI] + " pos. " + wrongI);
        if (newWord[wrongI + addI]) newWord[wrongI + addI].colour = "#FD6441/*red*/";
        wrongI++;

        // check if doubleError: same letter 2 times in a row, on time false: understand, that it was not a replacement, but an added wrong letter
        if (wrong[wrongI - 2] == wrong[wrongI - 1]) {
          newWord.splice(wrongI + addI, 0, {letter: '_', colour: "white"});
          addI++;
          doubleError++;
        }
}
else {
  newWord.splice(wrongI + addI, 0, {letter: '_', colour: "white"});
  addI++;
  // graphemFehler++;
}
    }
    // too much before end
    else if (((wrong[wrongI + 1] && wrong[wrongI + 1] == correct[i])) && correct[i] != wrong[wrongI]) {
      // console.log("remove " + wrong[wrongI] + " pos. " + wrongI);
      newWord[wrongI + addI].colour = "#FD6441/*red*/";
      doubleError++;
      i--;
      graphemFehler++;
      // if (!auswertung.wrongLetters[selectedElementId.parent]) auswertung.wrongLetters[selectedElementId.parent] = {};
      // if (!auswertung.wrongLetters[selectedElementId.parent][correct]) auswertung.wrongLetters[selectedElementId.parent][correct] = {};
      // if (!auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()]) auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()] = 0;
      // auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()]++;
    }
    if (!(correct[i] != wrong[wrongI] && (!wrong[wrongI + 1] || wrongI > i || (wrong[wrongI + 1] && wrong[wrongI + 1] != correct[i]))) || (wrong[wrongI + 1] && wrong[wrongI + 1].toLowerCase() == correct[i + 1])) wrongI++;
  }
  // check end missing
  for (var i = i; newWord.length - doubleError < correct.length; i++) {
    newWord.push({letter: '_', colour: "white"});
    addWrongLetter(correct, newWord.length - 1);
  }
  // check too much in the end
  for (var i = wrongI + addI; i < newWord.length && i >= correct.length; i++) {
    // console.log("remove " + wrong[i]);
    if (newWord[i].letter != '_') {
      newWord[i].colour = "#FD6441/*red*/";
      graphemFehler++;
      // if (!auswertung.wrongLetters[selectedElementId.parent]) auswertung.wrongLetters[selectedElementId.parent] = {};
      // if (!auswertung.wrongLetters[selectedElementId.parent][correct]) auswertung.wrongLetters[selectedElementId.parent][correct] = {};
      // if (!auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()]) auswertung.wrongLetters[selectedElementId.parent][correct][correct[i].toLowerCase()] = 0;
      // auswertung.wrongLetters[selectedElementId.parent][correct][newWord[i].toLowerCase()]++;
    }
  }
  // console.log(newWord);
  for (var i = 0; i < newWord.length && !doNotMark && graphemFehler > 0; i++) {
    addElement({id: 'correctionLetter', class: 'correctionLetter' + i, innerText: newWord[i].letter, style: 'background-color:' + newWord[i].colour + ';', title: 'klicken, um ' + newWord[i].letter + ' als gespiegelt (blau) zu markieren, oder die Markierung wieder zu entfernen.\nBei Veränderung der Schreibweise des Schülers wird das Wort nicht mehr als gespiegelt eingetragen sein.', onclick: 'changeMirror(' + i + ', "' + id + '");'}, 'strong', /*'correction ' + id.replace('pupilsWriting ', '')*/wordCorrectionChild, true);
  }
  if (correct.length - graphemFehler < 0) graphemFehler = correct.length;
  if (!doNotMark && graphemFehler > 0) {
    addElement({value: correct.length - graphemFehler, id: 'graphemtrefferGot', oninput: 'getAllGraphemtreffer();', class: 'graphemtrefferGot' + capitalizeFirstLetter(selectedElementId.parent), style: 'width: 25;'}, 'input', wordCorrectionChild, true);
    addElement({innerText: '/', id: 'graphemtrefferSlash', style: 'width: 25;'}, 'a', wordCorrectionChild, true);
    addElement({value: correct.length, id: 'graphemtrefferPossible', oninput: 'getAllGraphemtreffer();', class: 'graphemtrefferPossible' + capitalizeFirstLetter(selectedElementId.parent), style: 'width: 25;'}, 'input', wordCorrectionChild, true);
    findChild('id', selectedElementId.parent, id).style.backgroundColor = "red";
  }
  else {
    addElement({style: 'display: none;', value: correct.length - graphemFehler, id: 'graphemtrefferGot', class: 'graphemtrefferGot' + capitalizeFirstLetter(selectedElementId.parent)}, 'input', wordCorrectionChild, true);
    addElement({style: 'display: none;', value: correct.length, id: 'graphemtrefferPossible', class: 'graphemtrefferPossible' + capitalizeFirstLetter(selectedElementId.parent)}, 'input', wordCorrectionChild, true);
    findChild('id', selectedElementId.parent, id).style.backgroundColor = "green";
  }
  if ((doNotMark || correct == wrong) && !auswertung.wrongLetters[selectedElementId.parent]) auswertung.wrongLetters[selectedElementId.parent] = {};
  if (doNotMark || correct == wrong) auswertung.wrongLetters[selectedElementId.parent][correct] = {};
  getAllGraphemtreffer(doNotMark, graphemFehler, correct);
}
function getAllGraphemtreffer(/*doNotMark, graphemFehler, correct*/) {
  auswertung.allGraphemtreffer.possible = 0;
  auswertung.allGraphemtreffer.got = 0;
  for (var i = 0; i < document.getElementsByClassName("graphemtrefferGot" + capitalizeFirstLetter(selectedElementId.parent)).length; i++) {
    auswertung.allGraphemtreffer.possible += JSON.parse(document.getElementsByClassName("graphemtrefferPossible" + capitalizeFirstLetter(selectedElementId.parent))[i].value);
    auswertung.allGraphemtreffer.got += JSON.parse(document.getElementsByClassName("graphemtrefferGot" + capitalizeFirstLetter(selectedElementId.parent))[i].value);
  }
  document.getElementById('allGraphemes' + selectedElementId.parent.toString().split('Sheet')[1]).innerText = 'gesamt ' + auswertung.allGraphemtreffer.got + '/' + auswertung.allGraphemtreffer.possible;
}
function getEveryCategory() {
    for (var i = 0; i < neededTest.kathegorien.length; i++) {
      auswertung[neededTest.kathegorien[i]] = {got: 0, possible: 0};
        for (var i1 = 0; i1 < document.getElementsByClassName('writing' + capitalizeFirstLetter(selectedElementId.parent)).length; i1++) {
          if (neededTest.kathegorien[i].includes('Silben')) {
          if (neededTest.words[i1].toString().split('-').length == neededTest.kathegorien[i].replace(' Silben', '') && replaceAll(neededTest.words[i1], '-', '').toLowerCase() == document.getElementsByClassName('writing' + capitalizeFirstLetter(selectedElementId.parent))[i1].value.toLowerCase()) {
            auswertung[neededTest.kathegorien[i]].got++;
          }
          if (neededTest.words[i1].toString().split('-').length == neededTest.kathegorien[i].replace(' Silben', '')) auswertung[neededTest.kathegorien[i]].possible++;
        }
      }
    }
    auswertung.letter[selectedElementId.parent] = {};
    for (var i = 0; i < neededTest.words.length; i++) {
      try {
      var wordNow = replaceAll(neededTest.words[i], '-', '');
        var wrongLetterAblage = JSON.parse(JSON.stringify(auswertung.wrongLetters[selectedElementId.parent][wordNow]));
        // console.log(wordNow);
        for (var i1 = 0; i1 < wordNow.length; i1++) {
          var letterNow = wordNow[i1].toLowerCase();
          if (i1 == wordNow.length - 1 && letterNow == "e")  letterNow = '<' + letterNow + '>';
          if ( !auswertung.letter[selectedElementId.parent][letterNow]) auswertung.letter[selectedElementId.parent][letterNow] = {possible: 0, got: 0};
          auswertung.letter[selectedElementId.parent][letterNow].possible++;
          if (!auswertung.wrongLetters[selectedElementId.parent][wordNow] || (!auswertung.wrongLetters[selectedElementId.parent][wordNow][letterNow])) {
            auswertung.letter[selectedElementId.parent][letterNow].got++;
        }
        if (auswertung.wrongLetters[selectedElementId.parent][wordNow] && auswertung.wrongLetters[selectedElementId.parent][wordNow][letterNow]) auswertung.wrongLetters[selectedElementId.parent][wordNow][letterNow]--;
      }
      auswertung.wrongLetters[selectedElementId.parent][wordNow] = wrongLetterAblage;
     } catch (e) {
       console.log('not filled already');
     }
    }
    // console.log(auswertung);
    var wrongList = [];
    var rightList = [];
    var mirrorList = [];
    auswertung.letter[selectedElementId.parent] = sortObjectByKey(auswertung.letter[selectedElementId.parent]);
    var cathegoryList = Object.keys(auswertung.letter[selectedElementId.parent]);
    for (var i = 0; i < Object.keys(auswertung.letter[selectedElementId.parent]).length; i++) {
      wrongList.push(auswertung.letter[selectedElementId.parent][Object.keys(auswertung.letter[selectedElementId.parent])[i]].possible - auswertung.letter[selectedElementId.parent][Object.keys(auswertung.letter[selectedElementId.parent])[i]].got);
      rightList.push(auswertung.letter[selectedElementId.parent][Object.keys(auswertung.letter[selectedElementId.parent])[i]].got);
    }
    for (var i = 0; i < Object.keys(auswertung).length; i++) {
      if (Object.keys(auswertung)[i].includes('Silben')) {
        cathegoryList.push(Object.keys(auswertung)[i]);
        wrongList.push(auswertung[Object.keys(auswertung)[i]].possible - auswertung[Object.keys(auswertung)[i]].got);
        rightList.push(auswertung[Object.keys(auswertung)[i]].got);
      }
    }
    for (var i = 0; i < Object.keys(auswertung.letter[selectedElementId.parent]).length; i++) {
      mirrorList.push(0);
    }
    for (var i2 = 0; inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror && i2 < Object.keys(inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror).length; i2++) {
      for (var i4 = 0; i4 < inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror[Object.keys(inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror)[i2]].length; i4++) {
        if (inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror[Object.keys(inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror)[i2]][i4]) {
          for (var i = 0; i < cathegoryList.length; i++) {
            if (cathegoryList[i] == Object.keys(inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror)[i2][i4].toLowerCase()) {
              mirrorList[i]++;
              i = cathegoryList.length;
            }
          }
          if (i != cathegoryList.length + 1) {
            cathegoryList.push(Object.keys(inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror)[i2][i4].toLowerCase());
            mirrorList[i]++;
          }
        }
      }
      }
    addChart(cathegoryList, {wrong: wrongList, right: rightList, mirror: mirrorList});
}
function changeMirror(index, wordId) {
  var word = replaceAll(neededTest.words[wordId.replace('pupilsWriting ', '') - 1], '-', '');
  if (!inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror) inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror = {};
  if (!inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror[word]) {
    inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror[word] = [];
  }
  if (!inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror[word][index]) {
    inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror[word][index] = findChild('class',  findChild('id', selectedElementId.parent, wordId.replace('pupilsWriting', 'correction')), 'correctionLetter' + index, true).style.backgroundColor;
    findChild('class',  findChild('id', selectedElementId.parent, wordId.replace('pupilsWriting', 'correction')), 'correctionLetter' + index, true).style.backgroundColor = '#00BFFF'/*blue*/;
  }
  else {
  findChild('class',  findChild('id', selectedElementId.parent, wordId.replace('pupilsWriting', 'correction')), 'correctionLetter' + index, true).style.backgroundColor = inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror[word][index];
  inputs[/*'Test ' + */testSelctor.value][selectedElementId.parent].mirror[word][index] = undefined;
}
localStorage.setItem('inputsSchiku', JSON.stringify(inputs));
getEveryCategory();
}
function capitalizeFirstLetter(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
}
function sortObjectByKey(obj) {
  var keys = [],
  k, i, len;
for (k in obj) {
  if (obj.hasOwnProperty(k)) {
    keys.push(k);
  }
}
keys.sort();
len = keys.length;
var sorted = {}
for (i = 0; i < len; i++) {
  k = keys[i];
  sorted[k] = obj[k]
}
return sorted;
}
/*
 * PURPOSE : generiert ein neues HTML Element
 *  PARAMS : attr - Attribute des Elements
 *           elm - Typ des Elements
 *           childOf - in welchem welches HTML Element soll das neue eingefügt werden? (wenn nicht angegeben wird es ganz außen unten eingefügt)
 */
  function addElement(attr, elm, childOf, asElement) {
      var newElement = document.createElement(/*'span'*/elm);
      if (childOf && !asElement) document.getElementById(childOf).appendChild(newElement);
      else if (childOf) childOf.appendChild(newElement);
      else tests.appendChild(newElement);
      for (var i = 0; i < Object.keys(attr).length; i++) {
        if (Object.keys(attr)[i] == 'innerText') newElement.innerText = attr[Object.keys(attr)[i]];
        else newElement.setAttribute(Object.keys(attr)[i]/*'style'*/, /*'color:' + word[i].colour*/attr[Object.keys(attr)[i]]);
      }
    }

    /*!
 * Determine if an element is in the viewport
 * (c) 2017 Chris Ferdinandi, MIT License, https://gomakethings.com
 * @param  {Node}    elem The element
 * @return {Boolean}      Returns true if element is in the viewport
 */
 document.onkeydown = function(event) {
   if (event.key == 'Tab' && document.getElementById(selectedElementId.element.toString().split(' ')[0] + ' ' + (JSON.parse(selectedElementId.element.toString().split(' ')[1]) + 1))) {
     setTimeout(function () {
       if (selectedElementId.element.includes('pupilsWriting')) findChild('id', selectedElementId.parent, selectedElementId.element.toString().split(' ')[0] + ' ' + (JSON.parse(selectedElementId.element.toString().split(' ')[1]) + 1)).select();
     }, 10);
   }
   if (event.key == "p" && event.ctrlKey) alert('Rand, damit ein Schüler pro Blatt bleibt: links 17mm, oben 17,5mm, oder\nlinks 20mm, oben > 21mm\nwenn Sie andere Maße wollen, scrollen Sie bei der Vorschau bis zur letzten Seite und probieren Sie es selber aus, sodass der Name oben auf dem Blatt steht.\nTipp: stellen Sie eine Entfernung vom rechten Rand ein, die ihnen gefällt und verändern (meist verkleinern) Sie den Abstand vom oberen Rand so lange, bis der Name oben auf der Seite auftaucht.');
}
function replaceAll(str, find, replace) {
    return str.replace(new RegExp(find, 'g'), replace);
}
function addChart(texte, data) {
  // to refresh size (not working otherwise)
  document.getElementById('textur' + selectedElementId.parent).remove();
  addElement({id: 'textur' + selectedElementId.parent}, 'canvas', 'divGraph' + selectedElementId.parent.replace('pupilSheet', ''));
  var data = {
    labels: texte,//["b statt d", "h weggelassen", "t statt l"],
    datasets: [{
      label: "richtige",
      backgroundColor: 'rgba(0, 255, 0, 0.7)',
      borderColor: 'rgba(0, 255, 0, 1)',
      fill: true,
      data: data.right,//[5,3,7],
      stack:'stack0'
    }, {
      label: "falsche",
      backgroundColor: 'rgba(255, 0, 0, 0.7)',
      borderColor: 'rgba(255, 0, 0, 1)',
      fill: true,
      data: data.wrong,
      stack:'stack0'
    }, {
      label: "spiegelverkehrt",
      backgroundColor: '#00BFFF',
      borderColor: '#00BFFF',
      fill: true,
      data: data.mirror,
      stack:'stack0'
    }
    ]
  }
  var options = {
    maintainAspectRatio: false,
    responsive: true,
    scales: {
      xAxes: [{
        stacked: true
      }],
      yAxes: [{
        stacked: true,
        ticks: {
          beginAtZero: true
        }
      }],
    },
  }
  myBarChart[selectedElementId.parent.replace('pupilSheet', '')] = new Chart(document.getElementById('textur' + selectedElementId.parent), {
    type: 'horizontalBar',
    data: data,
    options: options
});
console.log("selectedElementId: " + selectedElementId.parent);
var chartNow = myBarChart[selectedElementId.parent.replace('pupilSheet', '')];
document.getElementById('textur' + selectedElementId.parent).onclick = function(evt) {
  console.log("chart");
  selectedElementId.parent = evt.path[0].id.replace('textur', '');
  var chartNow = myBarChart[selectedElementId.parent.replace('pupilSheet', '')];
  var activePoints = chartNow.getElementsAtEvent(evt);
  if (activePoints[0]) {
    var chartData = activePoints[0]['_chart'].config.data;
    var idx = activePoints[0]['_index'];
    var pupilSheet = chartNow.canvas.id.replace('textur', '');
    var label = chartData.labels[idx];
    var right = chartData.datasets[0].data[idx];
    var wrong = chartData.datasets[1].data[idx];
    console.log(label + ': ' + right + '/' + (wrong + right) + ' (' + wrong + ' wrong)');
    console.log("selectedElementId: " + pupilSheet);
      for (var i = 0; i < neededTest.words.length; i++) {

        findChild('id', pupilSheet, 'correction ' + (i + 1)).style.outlineStyle = "";
        if ((label.replace('>', '').replace('<', '').length == 1 && (neededTest.words[i].toLowerCase().includes(label.replace('>', '').replace('<', '').toLowerCase())) || (label.includes('Silben') && neededTest.words[i].toString().split('-').length == label.replace(' Silben', ''))) && findChild('id', pupilSheet, 'pupilsWriting ' + (i + 1)).value != "") {
          var result = undefined;
          if (label == 'e' && neededTest.words[i][neededTest.words[i].length - 1] == "e") {
            result = neededTest.words[i].split('');
            result.pop();
          }
          if (label.includes('Silben') || ((label != '<e>' && (!result || (result.join('').includes('e')))) || (label == '<e>' && neededTest.words[i][neededTest.words[i].length - 1] == "e"))) {
// ((label == '<e>' && neededTest.words[i][neededTest.words[i].length - 1] == "e") || (label != '<e>' && neededTest.words[i][neededTest.words[i].length - 1] != "e"))
          findChild('id', pupilSheet, 'correction ' + (i + 1)).style.outlineColor = "red";
          // TODO: <e>
          if ((!Object.keys(auswertung.wrongLetters[pupilSheet][replaceAll(neededTest.words[i], '-', '')]).length || (!auswertung.wrongLetters[pupilSheet][replaceAll(neededTest.words[i], '-', '')][label])) && (!(label.includes('Silben')) || findChild('id', pupilSheet, 'pupilsWriting ' + (i + 1)).value == replaceAll(neededTest.words[i], '-', ''))) findChild('id', pupilSheet, 'correction ' + (i + 1)).style.outlineColor = "green";
          findChild('id', pupilSheet, 'correction ' + (i + 1)).style.outlineStyle = "outset";
          findChild('id', pupilSheet, 'correction ' + (i + 1)).style.width = graphemtrefferPossible[neededTest.words.length*(pupilSheet.replace('pupilSheet', '') - 1) + i].getBoundingClientRect().right + 3;
          if (findChild('id', pupilSheet, 'pupilsWriting ' + (i + 1)).value == replaceAll(neededTest.words[i], '-', '')) findChild('id', pupilSheet, 'correction ' + (i + 1)).style.width = 7*replaceAll(neededTest.words[i], '-', '').length;
        }
      }
    }
  }
};
// TODO: nicht nur für pupil 1
var mostLeft = 0;
for (var i = 0; i < document.getElementsByClassName('writingPupilSheet1').length; i++) {
  if (document.getElementsByClassName('writingPupilSheet1')[i].getBoundingClientRect().right > mostLeft) mostLeft = document.getElementsByClassName('writingPupilSheet1')[i].getBoundingClientRect().right;
}
chartNow.canvas.parentNode.style.right = -20//(window.innerWidth - pupilSheet1.getBoundingClientRect().right);
chartNow.canvas.parentNode.style.width = window.innerWidth - mostLeft - 10 - (window.innerWidth - pupilSheet1.getBoundingClientRect().right);
chartNow.canvas.parentNode.style.height = 1;
chartNow.canvas.parentNode.style.top = document.getElementById(selectedElementId.parent).getBoundingClientRect().top + 40 + scrollY;
for (var graphBottom = /*texturpupilSheet1.getBoundingClientRect().bottom*/document.getElementById('divGraph' + selectedElementId.parent.replace('pupilSheet', '')).getBoundingClientRect().bottom; document.getElementById(selectedElementId.parent).getBoundingClientRect().bottom > graphBottom; graphBottom++) {
  chartNow.canvas.parentNode.style.height = JSON.parse(chartNow.canvas.parentNode.style.height.replace('px', '')) + 1 + 'px';
}
findChild('id', selectedElementId.parent, 'comment').style.width = window.innerWidth - mostLeft - 65- (window.innerWidth - pupilSheet1.getBoundingClientRect().right);
findChild('id', selectedElementId.parent, 'comment').style.height = 10;
makeTextboxBigger();
// chartNow.canvas.parentNode.style.right = (window.innerWidth - pupilSheet1.getBoundingClientRect().right)*2;

console.log(chartNow.canvas.parentNode.style.height);
}
// TODO: document.getElementById('pupilsWriting 1').getBoundingClientRect()
// addChart(['b korrekt', 'h korrekt', 'r korrekt'], {wrong: [1, 1, 1], right: [2, 2, 2]}, texturpupilSheet1);
</script>
